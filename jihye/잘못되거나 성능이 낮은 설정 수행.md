# í•­ëª© 86: HikariCP ì„¤ì • ì»¤ìŠ¤í„°ë§ˆì´ì§• ë°©ë²•
- spring boot ê¸°ë³¸ ì»¤ë„¥ì…˜í’€: HikariCP
- spring-boot-start-jdbc ë˜ëŠ” spring-boot-starter-data-jpa ìŠ¤íƒ€í„° ì¶”ê°€í•˜ë©´ HikariCP ìë™ ì¶”ê°€ ë¨.

> (in book) í”„ë¡œë•ì…˜ í™˜ê²½ ì»¤ë„¥ì…˜ í’€ íŒŒë¼ë¯¸í„° ì¡°ì •í•˜ëŠ”ë° FlexPool ì‚¬ìš© ê¶Œì¥ í•¨.   
> FlexPool: ì»¤ë„¥ì…˜ í’€ ê´€ë¦¬ ë„êµ¬. ìµœì ì˜ ì„¤ì • ì§€ì›.   
> https://github.com/vladmihalcea/flexy-pool 
> https://www.baeldung.com/spring-flexypool-guide

## ì»¤ë„¥ì…˜ í’€ êµ¬ì„± ë³€ê²½ ë°©ë²•
### 1) application.propertiesì—ì„œ spring.datasource.hikari.* ì†ì„± ì‚¬ìš©
application.propertiesì—ì„œ spring.datasource.hikari.*ë¥¼ ì‚¬ìš©í•˜ì—¬ HikariCPë¥¼ êµ¬ì„±í•¨.   
[ğŸ“ ì°¸ê³ . HikariCP íŒŒë¼ë¯¸í„°](https://github.com/brettwooldridge/HikariCP?tab=readme-ov-file#gear-configuration-knobs-baby)

```java
spring.datasource.hikari.connectionTimeout=50000
spring.datasource.hikari.idleTimeout=300000
spring.datasource.hikari.maxLifetime=900000
spring.datasource.hikari.maximumPoolSize=8
spring.datasource.hikari.minimumIdle=8
spring.datasource.hikari.poolName=MyPool
spring.datasource.hikari.connectionTestQuery=select 1 from dual
```
- connectionTimeout: HikariCP ì»¤ë„¥ì…˜ ìš”ì²­ í›„ ëŒ€ê¸°í•˜ëŠ” ì‹œê°„ 
- idleTimeout: ë†€ê³ ìˆëŠ” (idle) ì»¤ë„¥ì…˜ì´ ìë™ Close ë˜ê¸° ì „ ëŒ€ê¸°ì‹œê°„. ì»¤ë„¥ì…˜ì´ poolì—ì„œ ìœ íœ´ ìƒíƒœë¡œ ìœ ì§€ë  ìˆ˜ ìˆëŠ” ìµœëŒ€ ì‹œê°„
- maxLifetime: ì»¤ë„¥ì…˜ í’€ì—ì„œ ëŒ€ê¸°í•  ìˆ˜ ìˆëŠ” ì»¤ë„¥ì…˜ì˜ ìµœëŒ€ ìƒëª…ì£¼ê¸° ì‹œê°„
- minimumIdle: í’€ì—ì„œ ìœ ì§€ë  ìµœì†Œ ìœ í›„(Idle) ê°œìˆ˜. ì»¤ë„¥ì…˜ í’€ ìµœì†Œ í¬ê¸°. ê¸°ë³¸ ê°’.maximumPoolSizeì™€ ë™ì¼
- maximumPoolSize: ë°ì´í„°ë² ì´ìŠ¤ ì»¤ë„¥ì…˜ ì‹¤ì œ ìµœëŒ€ ê°’
- connectionTestQuery: JDBC4 ì§€ì›í•˜ëŠ” ê²½ìš°, í˜¸í™˜X. ì‚¬ìš©X. ë°ì´í„°ë² ì´ìŠ¤ì— ëŒ€í•œ ì—°ê²°ì´ ì•„ì§ ì‚´ì•„ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ì¿¼ë¦¬ 

### 2) apllicaion.propertiesì—ì„œ ì‚¬ìš©ì ì§€ì • ì†ì„±ê³¼ DataSourceBilder ì´ìš©
- `application.properties`ì—ì„œ ì‚¬ìš©ì ì§€ì • ì†ì„±(ì˜ˆ: `app.datasource.*`)ë¥¼ í†µí•´ HikariCP êµ¬ì„±.
- `DataSource`ë¥¼ ë°˜í™˜í•˜ëŠ” `@Bean`ì„ ì‘ì„±í•¨.

[ğŸ“ ì°¸ê³ . springboot data access](https://docs.spring.io/spring-boot/docs/2.1.x/reference/html/howto-data-access.html)

```java
app.datasource.url=jdbc:mysql://localhost:3306/numberdb?createDatabaseIfNotExist=true
app.datasource.username=root
app.datasource.password=root
app.datasource.initialization-mode=always
app.datasource.platform=mysql

app.datasource.connection-timeout=50000
app.datasource.idle-timeout=300000
app.datasource.max-lifetime=900000
app.datasource.maximum-pool-size=8
app.datasource.minimum-idle=8
app.datasource.pool-name=MyPool
app.datasource.connection-test-query=select 1 from dual
```
```java
@Configuration
public class ConfigureDataSource {
    @Bean
    @ConfigurationProperties("app.datasource")  // app.datasource ì†ì„± ë¡œë“œ
    public HikariDataSource dataSource(DataSourceProperties properties) {
        return properties.initializeDataSourceBuilder().type(HikariDataSource.class)
                .build();
    }
}
```

### 3) DataSourceBuilder ì´ìš© 
DataSourceBuilder APIë¡œ ì§ì ‘ ì„¤ì •
- HikariDataSource ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
- ë°ì´í„° ì†ŒìŠ¤ êµ¬ì„±ì„ ìœ„í•œ ì „ìš© ë©”ì„œë“œ í˜¸ì¶œ

```java
@Configuration
public class ConfigureDataSource {

    @Bean
    public HikariDataSource dataSource() {

        HikariDataSource hds = new HikariDataSource();

        hds.setJdbcUrl("jdbc:mysql://localhost:3306/numberdb?createDatabaseIfNotExist=true");
        hds.setUsername("root");
        hds.setPassword("root");
        hds.setConnectionTimeout(50000);
        hds.setIdleTimeout(300000);
        hds.setMaxLifetime(900000);
        hds.setMaximumPoolSize(8);
        hds.setMinimumIdle(8);
        hds.setPoolName("MyPool");
        hds.setConnectionTestQuery("select 1 from dual");
        hds.setAutoCommit(false);

        return hds;
    }
}

```

# í•­ëª© 87: 2ê°œì˜ ì»¤ë„¥ì…˜ í’€ì„ ê°–ëŠ” 2ê°œì˜ ë°ì´í„°ì†ŒìŠ¤ êµ¬ì„±ë°©ë²•
2ê°œì˜ ì»¤ë„¥ì…˜ í’€ì„ ê°–ëŠ” 2ê°œì˜ ë°ì´í„°ë² ì´ìŠ¤(ê° ë°ì´í„°ë² ì´ìŠ¤ì˜ ì„œë¡œ ë‹¤ë¥¸ ì„¤ì •ì˜ ìì²´ HikariCP ì—°ê²° í’€ì„ ì‚¬ìš©) êµ¬ì„± ë°©ë²•ì€ ì•„ë˜ì™€ ê°™ë‹¤.   
[ğŸ“ ì°¸ê³ . springboot Configure Two DataSources](https://docs.spring.io/spring-boot/docs/2.1.x/reference/html/howto-data-access.html#howto-two-datasources)

> Author ì—”í‹°í‹° ==> authoersdb ë°ì´í„°ë² ì´ìŠ¤ì˜ author í…Œì´ë¸”ë¡œ ë§¤í•‘
> Book ì—”í‹°í‹° ==> booksdb ë°ì´í„°ë² ì´ìŠ¤ì˜ book í…Œì´ë¸”

- application.propertiesì—ì„œ ë‘ ê°œì˜ ì‚¬ìš©ì ì •ì˜ ì„¤ì •(ì˜ˆ: app.datasource.ds1 ë° app.datasource.ds2)ë¥¼ í†µí•´ ë‘ ê°œì˜ HikariCP ì—°ê²° í’€ì„ êµ¬ì„±

```java
app.datasource.ds1.url=jdbc:mysql://localhost:3306/authorsdb?createDatabaseIfNotExist=true
app.datasource.ds1.username=root
app.datasource.ds1.password=root

app.datasource.ds2.url=jdbc:mysql://localhost:3306/booksdb?createDatabaseIfNotExist=true
app.datasource.ds2.username=root
app.datasource.ds2.password=root
```

- ì²« ë²ˆì§¸ DataSourceë¥¼ ë°˜í™˜í•˜ëŠ” @Beanì„ ì‘ì„±í•˜ê³  ì´ë¥¼ @Primaryë¡œ í‘œì‹œ
- ë‘ ë²ˆì§¸ DataSourceë¥¼ ë°˜í™˜í•˜ëŠ” ë˜ ë‹¤ë¥¸ @Beanì„ ì‘ì„±

```java
@Configuration
public class ConfigureDataSources {

    // first database, authorsdb
    @Primary
    @Bean(name = "configAuthorsDb")
    @ConfigurationProperties("app.datasource.ds1")
    public DataSourceProperties firstDataSourceProperties() {
        return new DataSourceProperties();
    }

    @Primary
    @Bean(name = "dataSourceAuthorsDb")
    @ConfigurationProperties("app.datasource.ds1")
    public HikariDataSource firstDataSource(@Qualifier("configAuthorsDb") DataSourceProperties properties) {
        return properties.initializeDataSourceBuilder().type(HikariDataSource.class)
                .build();
    }

    // second database, booksdb
    @Bean(name = "configBooksDb")
    @ConfigurationProperties("app.datasource.ds2")
    public DataSourceProperties secondDataSourceProperties() {
        return new DataSourceProperties();
    }

    @Bean(name = "dataSourceBooksDb")
    @ConfigurationProperties("app.datasource.ds2")
    public HikariDataSource secondDataSource(@Qualifier("configBooksDb") DataSourceProperties properties) {
        return properties.initializeDataSourceBuilder().type(HikariDataSource.class)
                .build();
    }
}
```

- ë‘ ê°œì˜ EntityManagerFactoryë¥¼ êµ¬ì„±í•˜ê³  ê°ê°ì„ ê²€ìƒ‰í•  íŒ¨í‚¤ì§€ë¥¼ ì§€ì •
- ê° EntityManagerì˜ ë„ë©”ì¸ê³¼ ì €ì¥ì†Œë¥¼ ì˜¬ë°”ë¥¸ íŒ¨í‚¤ì§€ì— ë„£ìŒ

```java
@Configuration
@EnableJpaRepositories(
        entityManagerFactoryRef = "ds1EntityManagerFactory",
        transactionManagerRef = "ds1TransactionManager",
        basePackages = "com.bookstore.ds1"
)
@EnableTransactionManagement
public class FirstEntityManagerFactory {

    @Bean
    @Primary
    public LocalContainerEntityManagerFactoryBean ds1EntityManagerFactory(
            EntityManagerFactoryBuilder builder, @Qualifier("dataSourceAuthorsDb") DataSource dataSource) {

        return builder
                .dataSource(dataSource)
                .packages(packagesToScan())
                .persistenceUnit("ds1-pu")
                .properties(hibernateProperties())
                .build();
    }
}
```

---

> í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ `hibernate.ddl-auto`ì„ í†µí•´ ìŠ¤í‚¤ë§ˆ ìƒì„± í•˜ì§€ ë§ì. Flywayë‚˜ schema-*.sql ì‚¬ìš© í•´ë¼

# í•­ëª© 92: ìŠ¤í”„ë§ ë¶€íŠ¸ì—ì„œ Flyway ì„¤ì • ë°©ë²•
í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ ìŠ¤í‚¤ë§ˆ DDLì„ ë°˜ì˜í•˜ë ¤ë©´ Flywayë‚˜ Liquibaseë¥¼ í™œìš© í•´ì•¼í•œë‹¤. hibernate.ddl-auto ì‚¬ìš©í•˜ì§€ ë§ì•„ì•¼ í•œë‹¤.   
FlywayëŠ” ë°ì´í„°ë² ì´ìŠ¤ì˜ ë³€ê²½ ì‚¬í•­ì„ ê´€ë¦¬í•˜ê³ , ì—…ë°ì´íŠ¸ë‚˜ ë¡¤ë°±ì„ ë³´ë‹¤ ì‰½ê²Œ í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ëŠ” ë„êµ¬ì´ë‹¤.

## Flyway ì‚¬ìš© ë°©ë²•
[ğŸ“ ì°¸ê³ . Flyway ì„¤ì •](https://www.blog.ecsimsw.com/entry/Flyway%EB%A1%9C-DB-Migration)

1. ì˜ì¡´ì„± ì¶”ê°€
- ë°ì´í„°ë² ì´ìŠ¤: Mysql

```java
<dependency>
    <groupId>org.flywaydb</groupId>
    <artifactId>flyway-core</artifactId>
</dependency>
<dependency>
    <groupId>org.flywaydb</groupId>
    <artifactId>flyway-mysql</artifactId>
</dependency>
```
2. ì–´í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì •ì¶”ê°€: application.properties

```yml
spring.datasource.url=jdbc:mysql://localhost:3306/bookstoredb?createDatabaseIfNotExist=true
# default
spring.flyway.enabled=true 
# ìƒˆë¡œìš´ ìŠ¤í¬ë¦½íŠ¸ë§Œ ì ìš©í•˜ê³ ì í•  ë•Œ ì„¤ì •
spring.flyway.baselineOnMigrate = true
```
3. ìŠ¤í‚¤ë§ˆ íŒŒì¼ ì¶”ê°€ 
íŒŒì¼ ê²½ë¡œ, íŒŒì¼ ì´ë¦„ ì¤‘ìš”!   

- ìœ„ì¹˜: `classpath:db/migration` ,spring.flyway.locationsë¥¼ í†µí•´ ì„¤ì • ê°€ëŠ¥
- ì½œë°± sql (afterMigation.sql, beforeClean.sql ë“±) ì‚¬ìš© ê°€ëŠ¥
- ê° SQL íŒŒì¼ ì´ë¦„ì€ `V1.1__Description.sql`, `V1.2__Description.sql`

## Flywayë¥¼ í†µí•œ ë°ì´í„°ë² ì´ìŠ¤ ìƒì„±
1. JDBC URLì—ì„œ ë°ì´í„°ë² ì´ìŠ¤ ì´ë¦„ ì œê±°
```yml
spring.datasource.url=jdbc:mysql://localhost:3306/
```
2. Flywayì—ì„œ spring.flyway.schemasë¥¼ í†µí•´ ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ ì§€ì‹œ
- ìŠ¤í‚¤ë§ˆ ë‘˜ ì´ìƒì¸ ê²½ìš° ì‰¼í‘œë¡œ êµ¬ë¶„
```yml
spring.flyway.schemas=bookstoredb
```

3. ì´ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë˜ì–´ì•¼ í•˜ëŠ” ê° ì—”í„°í‹°ì— ë°ì´í„°ë² ì´ìŠ¤ ì´ë¦„ ì§€ì •
```java
@Entity
@Table(schema = "bookstoredb") // or @Table(catalog = "bookstoredb")
public class Author implements Serializable {
...
}
```
4. ìŠ¤í‚¤ë§ˆ ì—…ë°ì´íŠ¸ê°€ í¬í•¨ëœ ê° SQL íŒŒì¼ì„ `classpath:db/migration`ì— ì¶”ê°€í•©ë‹ˆë‹¤.
- SQL íŒŒì¼ ì´ë¦„ì€ ëª…ëª… ê·œì¹™ ì¤€ìˆ˜(`V1.1__Description.sql`, `V1.2__Description.sql`)

## @FlywayDataSource

```java
@FlywayDataSource
    @Bean(initMethod = "migrate")
    public Flyway flyway(@Qualifier("dataSource") HikariDataSource dataSource) {

        return Flyway.configure()
                .dataSource(dataSource)                
                .locations("classpath:db/migration") // this path is default
                .load();
    }
```

# í•­ëª© 93: schema-*.sqlì„ í†µí•œ ë‘ ë°ì´í„°ë² ì´ìŠ¤ ìƒì„±ê³¼ ì—”í‹°í‹° ë§¤ì¹­ ë°©ë²•
1. ì–´í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì •ì¶”ê°€: application.properties
- ë°ì´í„°ë² ì´ìŠ¤ ì—†ì´ JDBC URL ì„¤ì •
- `schema-mysql.sql` íŒŒì¼ì—ì„œ ìŠ¤í‚¤ë§ˆë¥¼ ì´ˆê¸°í™”í•˜ë„ë¡ ì§€ì‹œ
```yml
spring.datasource.url=jdbc:mysql://localhost:3306
spring.datasource.username=root
spring.datasource.password=root

# schea-mysql.sql ì—ì„œ DDL ì‹¤í–‰í•˜ë„ë¡ ì„¤ì •
spring.datasource.initialization-mode=always
spring.datasource.platform=mysql
```

2. ì—”í„°í‹°ì— ë°ì´í„°ë² ì´ìŠ¤ ëª…ì‹œ
```java
// `Author` ì—”í„°í‹°ì—ì„œ `@Table(schema="authorsdb")`ë¥¼ í†µí•´ í•´ë‹¹ í…Œì´ë¸”(`author`)ì´ ë°ì´í„°ë² ì´ìŠ¤ `authorsdb`ì— ìˆìŒì„ ì§€ì •

@Entity
@Table(schema="authorsdb")
public class Author implements Serializable {
...
}
```